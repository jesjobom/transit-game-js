<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<title>TRANSITO</title>
	</head>
	<body>
		<h1>TRANSITO</h1>
		<div id="game_area"></div>
	</body>
	<script type="text/javascript">

	var binaryTable = [
		[0, 1, 0, 0, 0],
		[1, 1, 1, 1, 0],
		[0, 1, 0, 1, 1],
		[0, 1, 0, 0, 0]
	];

	var director = new director(3, binaryTable);
	director.start();

	function director(maxCars, binaryTable) {
		var self = this;
		
		var maxCars = maxCars;
		var mainTable = null;

		self.start = function() {
			mainTable = new table(binaryTable);
			loop();
		};

		function loop() {
			$("#game_area").html(mainTable.generateTable());
			if(mainTable.quantityCars() < maxCars) {
				mainTable.addCar(generateCar());
			}

			setTimeout(loop, 2000);
		}

		function generateCar() {
			return new car((Math.floor(Math.random() * 26) +10).toString(36));
		}
	}

	function table(binaryTable) {
		var self = this;

		var binaryTable = binaryTable;
		var cels = null;

		init();
		
		function init() {
			cels = [];

			for(line in binaryTable) {
				var tds = [];
				for(column in binaryTable[line]) {
					tds.push(new cel(self, binaryTable[line][column], column, line));
				}

				cels.push(tds);
			}
		}

		self.generateTable = function() {
			var table = $("<table></table>");

			for(line in cels) {
				var tr = $("<tr></tr>");
				for(cel in cels[line]) {
					tr.append(cels[line][cel].generateTd());
				}

				table.append(tr);
			}

			return table;
		};

		self.quantityCars = function() {
			var quantity = 0;
			for(line in cels) {
				for(cel in cels[line]) {
					quantity += cels[line][cel].quantityCars();
				}
			}
			return quantity;
		};

		self.addCar = function(car) {
			var selectedCel = null;

			for(line in cels) {
				for(cel in cels[line]) {
					if(cels[line][cel].isRoad() && cels[line][cel].quantityCars() == 0) {
						if(selectedCel == null) {
							selectedCel = cels[line][cel];

						} else {
							var tempCel = cels[line][cel];
							
							if       (tempCel.x < selectedCel.x && tempCel.x < (cels[line].length - selectedCel.x -1)) {
								selectedCel = tempCel;
							} else if(tempCel.x > selectedCel.x && selectedCel.x > (cels[line].length - tempCel.x -1)) {
								selectedCel = tempCel;
							} else if(tempCel.y < selectedCel.y && tempCel.y < (cels.length - selectedCel.y -1)) {
								selectedCel = tempCel;
							} else if(tempCel.y > selectedCel.y && selectedCel.y > (cels.length - tempCel.y -1)) {
								selectedCel = tempCel;
							}
						}
					}
				}
			}

			if(selectedCel != null) {
				selectedCel.addCar(car);
			}
		};

		self.getCelAt = function(x, y) {
			return cels[y][x];
		};

		self.getXDimension = function() {
			return cels[0].length;
		};

		self.getYDimension = function() {
			return cels.length;
		};
	}

	function cel(t, isRoad, x, y) {
		var self = this;
		
		var isRoad = isRoad;
		var cars = [];
		this.x = x;
		this.y = y;
		this.tableParent = t;

		self.generateTd = function() {
			var el = $("<td></td>", {
				style: generateStyle(),
				html: generateCars(),
				title: "[" + this.x + "," + this.y + "]"
			});
			if(cars.length > 0) {
				console.debug(el);
			}
			return el;
		};

		self.isRoad = function() {
			return isRoad ? true : false;
		};

		function generateCars() {
			if(cars.length == 0) {
				return "";
			}

			if(cars.length == 1) {
				return cars[0].id;
			}

			self.explodeCars();
			return "<span style='color: red;'>X</span>";
		}

		self.addCar = function(car) {
			cars.push(car);
			car.setCel(this);
			car.start();
		};

		self.removeCar = function(car) {
			cars.every(function(c, i) {
				if(c.id == car.id) {
					cars.splice(i, 1);
					return false;
				}
				return true;
			});
		};

		self.quantityCars = function() {
			return cars.length;
		};

		self.explodeCars = function() {
			cars.forEach(function(c){
				c.explode();
			});
			cars = [];
		};

		function generateStyle() {
			return "background-color: " + (isRoad ? "grey" : "white") + "; width: 20px; height: 20px; text-align: center;";
		}

		self.getNorthCel = function() {
			return getNeighborCel(0, -1);
		};

		self.getEastCel = function() {
			return getNeighborCel(1, 0);
		};

		self.getSouthCel = function() {
			return getNeighborCel(0, 1);
		};

		self.getWestCel = function() {
			return getNeighborCel(-1, 0);
		};

		function getNeighborCel(dX, dY) {
			if(self.x * 1 + dX < 0 || self.x * 1 + dX > self.tableParent.getXDimension()-1) {
				return null;
			}
			if(self.y * 1 + dY < 0 || self.y * 1 + dY > self.tableParent.getYDimension()-1) {
				return null;
			}
			var neighborCel = self.tableParent.getCelAt(self.x * 1 + dX, self.y * 1 + dY);
			return neighborCel;
		}
	}

	function car(id) {
		var self = this;

		this.id = id;
		var cel = null;
		var exploded = false;
		var lastDirection = null;
		
		self.explode = function() {
			exploded = true;
		};
		
		self.setCel = function(c) {
			cel = c;
		};

		self.start = function() {
			if(lastDirection == null) {
				loop();
			}
		};

		function loop() {
			if(!exploded) {
				var gotoCel = moveRandomly(null, cel.getNorthCel(), cel.getEastCel(), cel.getSouthCel(), cel.getWestCel());
				lastDirection = {};
				cel.removeCar(self);
				gotoCel.addCar(self);
			
				setTimeout(loop, 1900);
			}
		}
	}

	function moveRandomly(currentDirection, northCel, eastCel, southCel, westCel) {
		var guide = Math.random() * 4;

		if(guide < 1 && northCel != null && northCel.isRoad()) {
			return northCel;
		}
		if(guide < 2 && eastCel != null && eastCel.isRoad()) {
			return eastCel;
		}
		if(guide < 3 && southCel != null && southCel.isRoad()) {
			return southCel;
		}
		if(guide < 4 && westCel != null && westCel.isRoad()) {
			return westCel;
		}
		return moveRandomly(currentDirection, northCel, eastCel, southCel, westCel);
	}

	</script>
</html>
